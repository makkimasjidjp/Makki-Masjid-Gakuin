<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parent Portal | Makki Masjid Gakuin</title>
    <style>
        :root { --primary: #004d40; --gold: #d4af37; --bg: #f4f7f6; }
        body { background: var(--bg); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; }
        .parent-container { max-width: 1000px; margin: 20px auto; padding: 20px; }

        .header { background: var(--primary); color: white; padding: 20px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .header h2 { margin: 0; font-size: 1.5rem; }

        .nav-tabs { display: flex; gap: 10px; margin: 25px 0; background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .tab { flex: 1; padding: 12px; cursor: pointer; border: none; background: none; font-weight: bold; color: #666; transition: 0.3s; border-radius: 6px; font-size: 0.85rem; }
        .tab.active { background: var(--primary); color: white; }

        .child-card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); margin-bottom: 25px; border-top: 5px solid var(--gold); }
        .child-card h3 { color: var(--primary); margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px; }

        /* Academic History Table Styles */
        .hist-table { width: 100%; border-collapse: collapse; margin-top: 10px; table-layout: fixed; min-width: 850px; }
        .hist-table th { text-align: center; padding: 10px; font-size: 0.75rem; text-transform: uppercase; border: 1px solid #ddd; color: #ffffff !important; }
        .hist-table td { padding: 10px; border: 1px solid #eee; text-align: center; font-size: 0.85rem; }

        .attn-badge { padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 0.7rem; display: block; text-align: center; }
        .attn-P { background: #e8f5e9; color: #2e7d32; }
        .attn-A { background: #ffebee; color: #c62828; }
        .attn-L { background: #fff3e0; color: #ef6c00; }

        /* Progress (UPGRADED) */
        .progress-item { margin: 16px 0; padding: 12px; border: 1px solid #eee; border-radius: 10px; background: #fafafa; }
        .progress-label { display: flex; justify-content: space-between; align-items: baseline; gap: 10px; margin-bottom: 8px; }
        .progress-title { font-size: 0.9rem; font-weight: 700; color: #1f2937; }
        .progress-meta { font-size: 0.82rem; color: #6b7280; white-space: nowrap; }
        .progress-meta b { color: var(--primary); }

        /* Smooth bar (fallback & overall) */
        .bar-bg { background: #e5e7eb; height: 10px; border-radius: 999px; overflow: hidden; }
        .bar-fill { height: 100%; transition: 0.5s; border-radius: 999px; }

        /* Segmented levels bar */
        .seg-wrap { margin-top: 10px; }
        .seg-bar { display: grid; gap: 4px; }
        .seg { height: 10px; border-radius: 3px; background: #e5e7eb; }
        .seg.done { background: #2e7d32; }
        .seg.partial { background: #d4af37; } /* optional (not used now) */

        .hint-small { font-size: 0.78rem; color: #6b7280; margin-top: 8px; }

        /* Filter Style */
        .filter-box { margin-bottom: 15px; padding: 10px; border-radius: 8px; border: 1px solid #ddd; font-family: inherit; }

        /* Finance Styles */
        .finance-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .finance-table td { padding: 10px 0; border-bottom: 1px solid #eee; }
        .status-badge { display: inline-block; padding: 8px 15px; border-radius: 20px; font-weight: bold; margin-top: 15px; }
        .paid { background: #e8f5e9; color: #2e7d32; }
        .unpaid { background: #ffebee; color: #c62828; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 10% auto; padding: 25px; border-radius: 12px; width: 80%; max-width: 600px; max-height: 70vh; overflow-y: auto; position: relative; }
        .close-modal { position: absolute; right: 20px; top: 15px; font-size: 24px; cursor: pointer; color: #666; }

        .btn-logout { background: rgba(255,255,255,0.2); color: white; border: 1px solid white; padding: 8px 15px; border-radius: 6px; cursor: pointer; }
    </style>
</head>
<body>

    <div class="parent-container">
        <div class="header">
            <div>
                <h2 id="parentGreeting">Parent Portal</h2>
                <span id="currentMonthYear" style="opacity: 0.8;">February 2026</span>
            </div>
            <button class="btn-logout" onclick="logout()">Logout</button>
        </div>

        <div id="parentNoticeDisplay" style="margin-top: 20px;"></div>

        <div id="historyModal" class="modal">
            <div class="modal-content">
                <span class="close-modal" onclick="closeHistory()">&times;</span>
                <h3 style="color: var(--primary); border-bottom: 2px solid var(--gold); padding-bottom: 10px;">Notice History</h3>
                <div id="historyList"></div>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="tab active" id="btnReport" onclick="switchTab('report')">Overall Progress</button>
            <button class="tab" id="btnRecords" onclick="switchTab('records')">Academic Records</button>
            <button class="tab" id="btnFinance" onclick="switchTab('finance')">Fees & Invoices</button>
        </div>

        <div id="childrenContainer">
            <div style="text-align:center; padding: 50px; color: #666;">Loading student data...</div>
        </div>
    </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, getDocs, query, where, orderBy, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyAdA02h0pqEEQunobeSM4emZfPW1EjMKu4",
    authDomain: "makki-masjid-gakuin.firebaseapp.com",
    projectId: "makki-masjid-gakuin",
    storageBucket: "makki-masjid-gakuin.firebasestorage.app",
    messagingSenderId: "376596641128",
    appId: "1:376596641128:web:b49c1233aaed64ae6552dd"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const parentEmail = localStorage.getItem('userEmail');
const currentYear = 2026;
const currentMonthName = "Feb";
let studentsData = [];
window.allPayments = [];
let currentFilterMonth = 'all';

/**
 * SETTINGS for progress UI
 * - If goal <= SEGMENT_MAX, show blocks (each block = 1 level)
 * - If goal > SEGMENT_MAX, show smooth bar
 */
const SEGMENT_MAX = 40;

async function init() {
    if (!parentEmail) { window.location.href = 'index.html'; return; }
    try {
        const q = query(collection(db, "students"), where("parentEmail", "==", parentEmail));
        const studentSnap = await getDocs(q);
        studentsData = studentSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        const paySnap = await getDocs(collection(db, "payments"));
        window.allPayments = paySnap.docs.map(d => d.data());

        renderView('report');
        displayNotices();
    } catch (e) {
        console.error("Initialization Error:", e);
        document.getElementById('childrenContainer').innerHTML = "Error loading data. Please refresh.";
    }
}

window.renderView = (view) => {
    const container = document.getElementById('childrenContainer');
    container.innerHTML = "";

    if (studentsData.length === 0) {
        container.innerHTML = `<div class='child-card'>No students found linked to ${parentEmail}</div>`;
        return;
    }

    studentsData.forEach(child => {
        const card = document.createElement('div');
        card.className = 'child-card';

        if (view === 'report') {
            const lv = child.levels || { c1: 0, c2: 0, c3: 0 };
            const gl = child.goals || { c1: 0, c2: 0, c3: 0 };
            const labels = getDivisionLabels(child.division);

            // overall (combined)
            const curTotal = (toNum(lv.c1) + toNum(lv.c2) + toNum(lv.c3));
            const goalTotal = (toNum(gl.c1) + toNum(gl.c2) + toNum(gl.c3));

            card.innerHTML = `
                <h3>${child.name} <small style="color:#666; font-weight:normal;">| ${child.division}</small></h3>

                ${progressBar("⭐ Overall Completion", curTotal, goalTotal, { forceSmooth: true })}

                <div class="progress-item" style="border-left:4px solid #2e7d32;">
                    ${progressBar(labels[0], lv.c1, gl.c1)}
                </div>

                <div class="progress-item" style="border-left:4px solid #d4af37;">
                    ${progressBar(labels[1], lv.c2, gl.c2)}
                </div>

                <div class="progress-item" style="border-left:4px solid #00695c;">
                    ${progressBar(labels[2], lv.c3, gl.c3)}
                </div>

                <p style="margin-top:20px; font-size:0.9rem; color:#888;">Expected Completion: <strong>${child.eta || 'TBD'}</strong></p>
            `;
        } else if (view === 'records') {
            const labels = getDivisionLabels(child.division);
            let logs = child.logs || [];

            // Filter logic
            if (currentFilterMonth !== 'all') {
                logs = logs.filter(log => (log.date || "").split('-')[1] === currentFilterMonth);
            }

            let rowsHtml = logs.length > 0 ? logs.map(log => {
                const attnMatch = log.text.match(/\[Attn: (.*?)\]/);
                const perfMatch = log.text.match(/\] \[(.*?)\]/);
                const attn = attnMatch ? attnMatch[1] : "-";
                const perf = perfMatch ? perfMatch[1] : "-";
                const progressParts = log.text.split('|');

                const extractData = (part) => {
                    if(!part) return { lvl: "-", pg: "-" };
                    const lMatch = part.match(/Lvl (.*?) /);
                    const pMatch = part.match(/Pg (.*?)$/);
                    return { lvl: lMatch ? lMatch[1] : "-", pg: pMatch ? pMatch[1] : "-" };
                };

                const s1 = extractData(progressParts[0]);
                const s2 = extractData(progressParts[1]);
                const s3 = extractData(progressParts[2]);

                return `
                    <tr>
                        <td style="font-weight:bold;">${log.date}</td>
                        <td><span class="attn-badge attn-${attn}">${attn}</span></td>
                        <td style="background:#f0f7f7;">${s1.lvl}</td><td style="background:#f0f7f7; font-weight:bold; color:var(--primary);">${s1.pg}</td>
                        <td style="background:#f1f8e9;">${s2.lvl}</td><td style="background:#f1f8e9; font-weight:bold; color:var(--primary);">${s2.pg}</td>
                        <td style="background:#f9fbe7;">${s3.lvl}</td><td style="background:#f9fbe7; font-weight:bold; color:var(--primary);">${s3.pg}</td>
                        <td style="font-size:0.75rem; color:#555;">${perf}</td>
                    </tr>`;
            }).join('') : `<tr><td colspan="9" style="padding:30px; color:#999;">No records found for the selected month.</td></tr>`;

            card.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h3 style="margin:0;">${child.name} - Academic Grid</h3>
                    <select class="filter-box" onchange="window.filterMonth(this.value)">
                        <option value="all" ${currentFilterMonth === 'all' ? 'selected' : ''}>All Months</option>
                        <option value="01" ${currentFilterMonth === '01' ? 'selected' : ''}>January</option>
                        <option value="02" ${currentFilterMonth === '02' ? 'selected' : ''}>February</option>
                        <option value="03" ${currentFilterMonth === '03' ? 'selected' : ''}>March</option>
                        <option value="04" ${currentFilterMonth === '04' ? 'selected' : ''}>April</option>
                        <option value="05" ${currentFilterMonth === '05' ? 'selected' : ''}>May</option>
                        <option value="06" ${currentFilterMonth === '06' ? 'selected' : ''}>June</option>
                        <option value="07" ${currentFilterMonth === '07' ? 'selected' : ''}>July</option>
                        <option value="08" ${currentFilterMonth === '08' ? 'selected' : ''}>August</option>
                        <option value="09" ${currentFilterMonth === '09' ? 'selected' : ''}>September</option>
                        <option value="10" ${currentFilterMonth === '10' ? 'selected' : ''}>October</option>
                        <option value="11" ${currentFilterMonth === '11' ? 'selected' : ''}>November</option>
                        <option value="12" ${currentFilterMonth === '12' ? 'selected' : ''}>December</option>
                    </select>
                </div>
                <div style="overflow-x:auto;">
                    <table class="hist-table">
                        <thead>
                            <tr style="background:#004d40;">
                                <th rowspan="2" style="width:120px;">Date</th>
                                <th rowspan="2" style="width:60px;">Attn</th>
                                <th colspan="2" style="background:#00695c;">${labels[0]}</th>
                                <th colspan="2" style="background:#2e7d32;">${labels[1]}</th>
                                <th colspan="2" style="background:#558b2f;">${labels[2]}</th>
                                <th rowspan="2" style="width:120px;">Perf.</th>
                            </tr>
                            <tr style="background:#004d40; font-size:0.7rem;">
                                <th style="width:50px; border-top:1px solid #005a4a;">Lvl</th><th style="width:50px; border-top:1px solid #005a4a;">Pg</th>
                                <th style="width:50px; border-top:1px solid #005a4a;">Lvl</th><th style="width:50px; border-top:1px solid #005a4a;">Pg</th>
                                <th style="width:50px; border-top:1px solid #005a4a;">Lvl</th><th style="width:50px; border-top:1px solid #005a4a;">Pg</th>
                            </tr>
                        </thead>
                        <tbody>${rowsHtml}</tbody>
                    </table>
                </div>
            `;
        } else if (view === 'finance') {
            const studentPayments = window.allPayments.filter(p => p.studentId === child.id);
            const isPaidThisMonth = studentPayments.some(p => p.monthName === currentMonthName && p.year === currentYear);
            const mFee = Number(child.monthlyFee) || 0;
            const tFee = Number(child.transportFee) || 0;
            const totalDue = mFee + tFee;

            card.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid #eee; padding-bottom:10px; margin-bottom:15px;">
                    <h3 style="margin:0;">${child.name}</h3>
                    <div class="status-badge ${isPaidThisMonth ? 'paid' : 'unpaid'}" style="margin:0; font-size:0.8rem;">
                        ${isPaidThisMonth ? 'Current Month: Paid ✅' : 'Current Month: Due'}
                    </div>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:20px;">
                    <div style="background:#f9f9f9; padding:15px; border-radius:8px; border-left:4px solid var(--primary);">
                        <label style="font-size:0.7rem; color:#666; text-transform:uppercase;">Monthly Commitment</label>
                        <div style="font-weight:bold; color:var(--primary);">¥${totalDue.toLocaleString()}</div>
                    </div>
                    <div style="background:#f9f9f9; padding:15px; border-radius:8px; border-left:4px solid ${isPaidThisMonth ? '#2e7d32' : '#c62828'};">
                        <label style="font-size:0.7rem; color:#666; text-transform:uppercase;">Balance Due</label>
                        <div style="font-weight:bold; color:${isPaidThisMonth ? '#2e7d32' : '#c62828'};">¥${isPaidThisMonth ? '0' : totalDue.toLocaleString()}</div>
                    </div>
                </div>
                <h4 style="font-size:0.9rem; color:var(--primary); margin-bottom:10px;">Payment History</h4>
                <div style="overflow-x:auto;">
                    <table class="finance-table" style="font-size:0.85rem;">
                        <thead><tr style="text-align:left; background:#eee;"><th style="padding:8px;">Month</th><th style="padding:8px;">Date Paid</th><th style="padding:8px; text-align:right;">Amount</th></tr></thead>
                        <tbody>
                            ${studentPayments.length > 0 ? studentPayments.sort((a,b) => b.timestamp - a.timestamp).map(p => `
                                <tr><td style="padding:8px;">${p.monthName} ${p.year}</td><td style="padding:8px;">${p.datePaid || '—'}</td><td style="padding:8px; text-align:right; font-weight:bold;">¥${(p.amount || 0).toLocaleString()}</td></tr>
                            `).join('') : '<tr><td colspan="3" style="text-align:center; padding:20px; color:#999;">No payment records found.</td></tr>'}
                        </tbody>
                    </table>
                </div>
            `;
        }

        container.appendChild(card);
    });
};

window.filterMonth = (val) => {
    currentFilterMonth = val;
    renderView('records');
};

/* ------------------- PROGRESS UI (UPGRADED) ------------------- */

function toNum(v) {
    const n = Number(v);
    return Number.isFinite(n) ? n : 0;
}

function clamp(n, min, max) {
    return Math.max(min, Math.min(max, n));
}

function progressBar(label, curRaw, goalRaw, opts = {}) {
    const cur = clamp(toNum(curRaw), 0, 999999);
    const goal = clamp(toNum(goalRaw), 0, 999999);

    // If no goal set, show simple message
    if (!goal) {
        return `
            <div class="progress-label">
                <span class="progress-title">${escapeHtml(label)}</span>
                <span class="progress-meta"><b>Goal not set</b></span>
            </div>
            <div class="bar-bg"><div class="bar-fill" style="width:0%; background:#cbd5e1;"></div></div>
            <div class="hint-small">Admin needs to set enrollment goals to show level progress.</div>
        `;
    }

    const safeCur = clamp(cur, 0, goal);
    const perc = Math.round((safeCur / goal) * 100);

    // Color scale: red -> gold -> green
    const fillColor = perc >= 80 ? "#2e7d32" : (perc >= 40 ? "var(--gold)" : "#c62828");

    const meta = `<span class="progress-meta"><b>${safeCur}</b> / ${goal} &nbsp;•&nbsp; <b>${perc}%</b></span>`;

    // Decide segmented vs smooth
    const useSmooth = opts.forceSmooth === true || goal > SEGMENT_MAX;

    if (useSmooth) {
        return `
            <div class="progress-label">
                <span class="progress-title">${escapeHtml(label)}</span>
                ${meta}
            </div>
            <div class="bar-bg">
                <div class="bar-fill" style="width:${perc}%; background:${fillColor};"></div>
            </div>
        `;
    }

    // Segmented bar (each segment = 1 level)
    const cols = goal <= 20 ? goal : 20; // max 20 columns; more rows automatically
    const segs = Array.from({ length: goal }, (_, i) => {
        const done = i < safeCur;
        return `<div class="seg ${done ? "done" : ""}" title="Level ${i+1}"></div>`;
    }).join("");

    return `
        <div class="progress-label">
            <span class="progress-title">${escapeHtml(label)}</span>
            ${meta}
        </div>
        <div class="bar-bg" style="height:10px; margin-bottom:10px;">
            <div class="bar-fill" style="width:${perc}%; background:${fillColor};"></div>
        </div>
        <div class="seg-wrap">
            <div class="seg-bar" style="grid-template-columns: repeat(${cols}, 1fr);">
                ${segs}
            </div>
            <div class="hint-small">✅ Green blocks = completed levels &nbsp;&nbsp;⬜ Grey blocks = remaining</div>
        </div>
    `;
}

function escapeHtml(str) {
    return String(str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
}

/* ------------------- ORIGINAL HELPERS (UNCHANGED) ------------------- */

function getDivisionLabels(div) {
    if (div === "Nazera") return ["Nazera Juzu", "Tajweed Rules", "Duas & IS"];
    if (div === "Hifz") return ["Daily Sabaq", "Sabaqi (Recent)", "Ammi (Revision)"];
    return ["Qaida Lessons", "Masnoon Duas", "Islamic Etiquettes"];
}

window.switchTab = (view) => {
    document.getElementById('btnReport').classList.toggle('active', view === 'report');
    document.getElementById('btnRecords').classList.toggle('active', view === 'records');
    document.getElementById('btnFinance').classList.toggle('active', view === 'finance');
    renderView(view);
};

window.logout = () => { localStorage.clear(); window.location.href = 'index.html'; };

window.displayNotices = async () => {
    try {
        const q = query(collection(db, "notices"), orderBy("timestamp", "desc"));
        const snap = await getDocs(q);
        const noticeDiv = document.getElementById('parentNoticeDisplay');
        const historyList = document.getElementById('historyList');
        noticeDiv.innerHTML = "";
        historyList.innerHTML = "";
        let count = 0;
        snap.forEach(docSnap => {
            const data = docSnap.data();
            if (count === 0) {
                noticeDiv.innerHTML = `
                    <div style="background:#fff9c4; border-left:5px solid #fbc02d; padding:15px; margin-bottom:20px; display:flex; justify-content:space-between; align-items:flex-start;">
                        <span style="white-space: pre-wrap; flex: 1; font-family: inherit;"><strong>Latest Notice:</strong>\n${data.message}</span>
                        <button onclick="window.openHistory()" style="background:white; border:1px solid #fbc02d; cursor:pointer; font-size:0.7rem; padding:4px 8px; border-radius:4px; margin-left:10px; white-space: nowrap;">History</button>
                    </div>`;
            }
            historyList.innerHTML += `<div class="history-item"><div class="history-date" style="color:var(--gold); font-size:0.75rem; font-weight:bold;">${data.date}</div><div style="margin-top:5px; white-space: pre-wrap;">${data.message}</div></div>`;
            count++;
        });
    } catch (e) { console.error("Notice Error:", e); }
};

window.openHistory = () => { document.getElementById('historyModal').style.display = 'block'; };
window.closeHistory = () => { document.getElementById('historyModal').style.display = 'none'; };

init();
</script>
</body>
</html>
