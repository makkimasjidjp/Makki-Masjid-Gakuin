<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Teacher Portal | Makki Masjid Gakuin</title>
    <style>
        :root { 
            --primary: #004d40; 
            --primary-light: #338573;
            --gold: #d4af37; 
            --bg: #f4f7f6;
            --danger: #c62828;
            --success: #2e7d32;
            --warning: #ef6c00;
            --info: #0288d1;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body { 
            background: var(--bg); 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif; 
            margin: 0; 
            line-height: 1.5;
        }
        
        .teacher-container { 
            max-width: 1200px; 
            margin: 10px auto; 
            padding: 10px; 
        }
        
        /* Header */
        .header { 
            background: linear-gradient(135deg, var(--primary) 0%, #00695c 100%);
            color: white; 
            padding: 20px; 
            border-radius: 16px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
        }
        
        .header h1 { 
            margin: 0; 
            font-size: 1.3rem; 
        }
        
        .header p {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-top: 5px;
        }
        
        /* Sections */
        .section { 
            background: white; 
            padding: 20px; 
            border-radius: 16px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
            margin-top: 15px; 
        }
        
        .section h3 { 
            color: var(--primary); 
            border-bottom: 2px solid var(--bg); 
            padding-bottom: 12px; 
            margin-top: 0; 
            margin-bottom: 20px;
            font-size: 1.2rem;
        }
        
        /* Tabs */
        .tab-container {
            margin-top: 20px;
            display: flex;
            gap: 5px;
            border-bottom: 2px solid #ddd;
            padding-bottom: 0;
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
        }
        
        .tab-btn { 
            padding: 12px 16px; 
            border: none; 
            border-radius: 12px 12px 0 0; 
            cursor: pointer; 
            background: #e0e0e0; 
            font-weight: 600; 
            transition: all 0.3s; 
            font-size: 0.9rem;
            min-width: 100px;
        }
        
        .tab-btn.active { 
            background: var(--primary); 
            color: white; 
        }
        
        .tab-content { 
            display: none; 
        }
        
        .tab-content.active { 
            display: block; 
        }
        
        /* Buttons */
        .btn-logout { 
            background: rgba(255,255,255,0.2); 
            color: white; 
            border: 1px solid rgba(255,255,255,0.3); 
            padding: 10px 16px; 
            border-radius: 30px; 
            cursor: pointer; 
            font-weight: 600;
            backdrop-filter: blur(5px);
            transition: all 0.3s;
        }
        
        .btn-logout:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .btn-submit { 
            background: linear-gradient(135deg, var(--primary) 0%, #00695c 100%);
            color: white; 
            border: none; 
            padding: 16px; 
            width: 100%; 
            border-radius: 12px; 
            cursor: pointer; 
            font-size: 1.1rem; 
            font-weight: bold; 
            margin-top: 20px; 
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0,77,64,0.3);
        }
        
        .btn-submit:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,77,64,0.4);
        }
        
        .btn-submit:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-ghost {
            background: white;
            border: 2px solid var(--primary);
            color: var(--primary);
            padding: 12px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .btn-ghost:hover {
            background: var(--primary);
            color: white;
        }
        
        /* Progress Bars */
        .progress-bar-bg { 
            background: #eee; 
            height: 6px; 
            border-radius: 3px; 
            width: 100%; 
            display: inline-block; 
        }
        
        .progress-fill { 
            background: var(--gold); 
            height: 100%; 
            border-radius: 3px; 
            transition: width 0.3s ease;
        }
        
        /* Attendance Badges */
        .attn-badge { 
            padding: 4px 8px; 
            border-radius: 20px; 
            font-weight: bold; 
            font-size: 0.8rem; 
            display: inline-block; 
            text-align: center; 
            min-width: 30px;
        }
        
        .attn-P { 
            background: #e8f5e9; 
            color: #2e7d32; 
        }
        
        .attn-A { 
            background: #ffebee; 
            color: #c62828; 
        }
        
        .attn-L { 
            background: #fff3e0; 
            color: #ef6c00; 
        }
        
        /* NEW: Simplified Bulk Input Grid */
        .date-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
        }
        
        .date-label {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--primary);
            font-size: 1.1rem;
        }
        
        .date-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 12px;
            font-size: 1.1rem;
            font-family: inherit;
            background: white;
        }
        
        .date-input:focus {
            border-color: var(--primary);
            outline: none;
        }
        
        /* Quick Actions Bar */
        .quick-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            background: #f0f0f0;
            padding: 15px;
            border-radius: 16px;
        }
        
        .quick-action-btn {
            flex: 1;
            min-width: 100px;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            background: white;
            color: var(--primary);
            border: 1px solid var(--primary);
            transition: all 0.2s;
        }
        
        .quick-action-btn:hover {
            background: var(--primary);
            color: white;
        }
        
        /* Student Grid */
        .student-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .student-grid-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 16px;
            padding: 15px;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .student-grid-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: var(--primary);
        }
        
        .student-grid-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .student-grid-name {
            font-weight: 700;
            color: var(--primary);
            font-size: 1.1rem;
        }
        
        .student-grid-id {
            background: var(--bg);
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 0.75rem;
            color: #666;
        }
        
        /* Attendance Toggle Buttons */
        .attendance-toggle {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            background: #f5f5f5;
            padding: 5px;
            border-radius: 12px;
        }
        
        .att-toggle-btn {
            flex: 1;
            padding: 10px 5px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            background: transparent;
            color: #666;
            transition: all 0.2s;
        }
        
        .att-toggle-btn.active[data-value="P"] {
            background: #e8f5e9;
            color: #2e7d32;
            font-weight: 700;
        }
        
        .att-toggle-btn.active[data-value="A"] {
            background: #ffebee;
            color: #c62828;
            font-weight: 700;
        }
        
        .att-toggle-btn.active[data-value="L"] {
            background: #fff3e0;
            color: #ef6c00;
            font-weight: 700;
        }
        
        /* Subject Row */
        .subject-row {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            align-items: center;
        }
        
        .subject-label {
            width: 40px;
            font-weight: 600;
            color: var(--primary);
            font-size: 0.9rem;
        }
        
        .subject-level {
            flex: 1;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            width: 80px;
            text-align: center;
        }
        
        .subject-page {
            flex: 2;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            background: white;
        }
        
        .subject-level:focus,
        .subject-page:focus {
            border-color: var(--primary);
            outline: none;
        }
        
        .subject-level.error {
            border-color: var(--danger);
            background: #ffebee;
        }
        
        /* Performance Quick Select */
        .performance-quick {
            display: flex;
            gap: 5px;
            margin-top: 10px;
            background: #f5f5f5;
            padding: 5px;
            border-radius: 12px;
        }
        
        .perf-quick-btn {
            flex: 1;
            padding: 8px 5px;
            border: none;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            background: transparent;
            color: #666;
            transition: all 0.2s;
        }
        
        .perf-quick-btn.active[data-value="Excellent"] {
            background: #4caf50;
            color: white;
        }
        
        .perf-quick-btn.active[data-value="Good"] {
            background: #2196f3;
            color: white;
        }
        
        .perf-quick-btn.active[data-value="Average"] {
            background: #ff9800;
            color: white;
        }
        
        .perf-quick-btn.active[data-value="Poor"] {
            background: #f44336;
            color: white;
        }
        
        /* Progress Summary */
        .progress-summary {
            margin-top: 15px;
            background: #f8f9fa;
            padding: 12px;
            border-radius: 12px;
            font-size: 0.85rem;
        }
        
        .progress-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary);
            color: white;
            padding: 12px 24px;
            border-radius: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 9999;
            animation: slideUp 0.3s ease;
            font-weight: 500;
        }
        
        @keyframes slideUp {
            from {
                transform: translate(-50%, 100%);
                opacity: 0;
            }
            to {
                transform: translate(-50%, 0);
                opacity: 1;
            }
        }
        
        /* Spinner */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
            vertical-align: middle;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Filter Container */
        .filter-container { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 20px; 
            flex-wrap: wrap; 
        }
        
        .filter-container select { 
            padding: 14px; 
            border-radius: 10px; 
            border: 2px solid #ddd; 
            flex: 1; 
            min-width: 200px; 
            font-size: 1rem;
            background: white;
        }
        
        .filter-container select:focus {
            border-color: var(--primary);
            outline: none;
        }
        
        /* Notice Bar */
        #noticeBar {
            background: #fff3cd;
            padding: 15px;
            border-radius: 12px;
            margin-top: 15px;
            border-left: 5px solid var(--gold);
            font-weight: bold;
            color: #856404;
        }
        
        /* History Table */
        .hist-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        
        .hist-table th { 
            text-align: center; 
            color: white; 
            background: var(--primary); 
            padding: 12px 5px;
            font-size: 0.8rem;
        }
        
        .hist-table td { 
            text-align: center; 
            padding: 10px 5px;
            border: 1px solid #ddd;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .student-grid {
                grid-template-columns: 1fr;
            }
            
            .quick-actions {
                flex-direction: column;
            }
            
            .quick-action-btn {
                width: 100%;
            }
            
            .subject-row {
                flex-wrap: wrap;
            }
            
            .subject-label {
                width: 100%;
                margin-bottom: 5px;
            }
            
            .subject-level,
            .subject-page {
                flex: 1;
            }
        }
        
        /* Progress Table */
        .progress-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .progress-table th {
            text-align: left;
            padding: 12px;
            background: var(--primary);
            color: white;
        }
        
        .progress-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }
    </style>
</head>
<body>

<div class="teacher-container">
    <div class="header">
        <div>
            <h1 id="teacherGreeting">Assalamu Alaikum</h1>
            <p id="divisionInfo">Division: Loading...</p>
        </div>
        <button class="btn-logout" onclick="logout()">üö™ Logout</button>
    </div>

    <div id="noticeBar" style="display:none;">
        <marquee id="noticeText" behavior="scroll" direction="left"></marquee>
    </div>

    <div class="tab-container">
        <button class="tab-btn active" id="btn-dashboard" onclick="switchTab('dashboard')">üìä Progress</button>
        <button class="tab-btn" id="btn-inputTab" onclick="switchTab('inputTab')">‚úçÔ∏è Daily Input</button>
        <button class="tab-btn" id="btn-historyTab" onclick="switchTab('historyTab')">üìú History</button>
    </div>

    <!-- Dashboard Tab -->
    <div id="dashboard" class="tab-content active">
        <div class="section">
            <h3>üìñ Student Progress Overview</h3>
            <div style="overflow-x: auto;">
                <table class="progress-table">
                    <thead>
                        <tr><th>Student Name</th><th>Level Progress</th></tr>
                    </thead>
                    <tbody id="myStudentList">
                        <tr><td colspan="2" style="text-align:center;">Loading students...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Daily Input Tab - Simplified Grid View -->
    <div id="inputTab" class="tab-content">
        <div class="section">
            <h3>üìù Daily Class Records</h3>
            
            <!-- Date Selection -->
            <div class="date-section">
                <div class="date-label">
                    <span>üìÖ</span>
                    <span>Select Date</span>
                </div>
                <input type="date" id="batchDate" class="date-input" value="">
            </div>
            
            <!-- Quick Actions -->
            <div class="quick-actions">
                <button class="quick-action-btn" onclick="setAllAttendance('P')">‚úÖ All Present</button>
                <button class="quick-action-btn" onclick="setAllAttendance('A')">‚ùå All Absent</button>
                <button class="quick-action-btn" onclick="setAllPerformance('Good')">‚≠ê All Good</button>
                <button class="quick-action-btn" onclick="resetPageNumbers()">üìÑ Reset Pages</button>
            </div>
            
            <!-- Student Grid Container -->
            <div id="studentGridContainer">
                <!-- Dynamically populated -->
            </div>
            
            <!-- Submit Button -->
            <button class="btn-submit" id="submitAllBtn" onclick="submitAllRecords()">
                üíæ Save All Records
            </button>
        </div>
    </div>

    <!-- History Tab -->
    <div id="historyTab" class="tab-content">
        <div class="section">
            <h3>üìú Monthly Academic Record</h3>
            <div class="filter-container">
                <select id="historyStudentSelect">
                    <option value="">-- Choose Student --</option>
                </select>
                <select id="historyMonthFilter">
                    <option value="all">All Months</option>
                    <option value="01">January</option>
                    <option value="02">February</option>
                    <option value="03">March</option>
                    <option value="04">April</option>
                    <option value="05">May</option>
                    <option value="06">June</option>
                    <option value="07">July</option>
                    <option value="08">August</option>
                    <option value="09">September</option>
                    <option value="10">October</option>
                    <option value="11">November</option>
                    <option value="12">December</option>
                </select>
            </div>
            <div id="historyResult" style="overflow-x: auto;">
                <p style="color:#666; text-align:center; padding:20px;">Select a student to view records</p>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, getDocs, collection, query, where, updateDoc, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAdA02h0pqEEQunobeSM4emZfPW1EjMKu4",
        authDomain: "makki-masjid-gakuin.firebaseapp.com",
        projectId: "makki-masjid-gakuin",
        storageBucket: "makki-masjid-gakuin.firebasestorage.app",
        messagingSenderId: "376596641128",
        appId: "1:376596641128:web:b49c1233aaed64ae6552dd"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const divisionLabels = {
        "Maktab": ["Qaida", "Dua", "Islamic Studies"],
        "Nazera": ["Para", "Tajweed", "Islamic Studies"],
        "Hifz": ["Para", "Tajweed", "Islamic Studies"]
    };

    const teacherEmail = localStorage.getItem('userEmail');
    let teacherData = null;
    let studentsList = [];

    // Initialize
    async function init() {
        if (!teacherEmail) { 
            window.location.href = 'index.html'; 
            return; 
        }
        try {
            const tDoc = await getDoc(doc(db, "users", teacherEmail));
            if (tDoc.exists()) {
                teacherData = tDoc.data();
                document.getElementById('teacherGreeting').innerText = "Assalamu Alaikum, " + (teacherData.name || "Teacher");
                document.getElementById('divisionInfo').innerText = "Division: " + (teacherData.division || "Not Assigned");
                
                // Set today's date
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('batchDate').value = today;
                
                loadNotice();
                loadStudents();
            } else {
                alert("Teacher profile not found.");
            }
        } catch (err) {
            console.error("Init Error:", err);
        }
    }

    // Tab Switching
    window.switchTab = (tabId) => {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        document.getElementById('btn-' + tabId).classList.add('active');
        
        if(tabId === 'dashboard') loadStudents();
        if(tabId === 'inputTab') renderStudentGrid();
        if(tabId === 'historyTab') populateHistoryDropdown();
    };

    // Load students for dashboard
    async function loadStudents() {
        const list = document.getElementById('myStudentList');
        if (!teacherData || !teacherData.division) return;
        
        const q = query(collection(db, "students"), where("division", "==", teacherData.division));
        const snap = await getDocs(q);
        list.innerHTML = "";
        
        if (snap.empty) {
            list.innerHTML = '<tr><td colspan="2" style="text-align:center;">No students found</td></tr>';
            return;
        }
        
        const labels = divisionLabels[teacherData.division] || ["S1", "S2", "S3"];
        snap.forEach(docSnap => {
            const s = docSnap.data();
            const lv = s.levels || { c1: 0, c2: 0, c3: 0 };
            const gl = s.goals || { c1: 1, c2: 1, c3: 1 };
            
            const createBar = (cur, goal, lbl) => {
                const perc = Math.min(Math.round((cur / (goal || 1)) * 100), 100);
                return `<div style="margin-bottom:8px;">
                            <div style="display:flex; justify-content:space-between; font-size:11px;">
                                <strong>${lbl}</strong> <span>${cur}/${goal}</span>
                            </div>
                            <div class="progress-bar-bg"><div class="progress-fill" style="width:${perc}%"></div></div>
                        </div>`;
            };
            
            const tr = document.createElement('tr');
            tr.innerHTML = `<td><strong>${s.name}</strong></td>
                            <td>${createBar(lv.c1, gl.c1, labels[0])} 
                                ${createBar(lv.c2, gl.c2, labels[1])} 
                                ${createBar(lv.c3, gl.c3, labels[2])}</td>`;
            list.appendChild(tr);
        });
    }

    // Render Student Grid (Simplified Bulk Input)
    async function renderStudentGrid() {
        const container = document.getElementById('studentGridContainer');
        const labels = divisionLabels[teacherData.division] || ["S1", "S2", "S3"];
        
        // Fetch students
        const q = query(collection(db, "students"), where("division", "==", teacherData.division));
        const snap = await getDocs(q);
        
        if (snap.empty) {
            container.innerHTML = '<p style="text-align:center; padding:20px;">No students found</p>';
            return;
        }
        
        studentsList = [];
        
        // Generate page options based on division
        const maxPages = teacherData.division === "Hifz" ? 604 : 
                         teacherData.division === "Nazera" ? 604 : 50;
        
        let gridHtml = '<div class="student-grid">';
        
        snap.forEach(doc => {
            const s = doc.data();
            studentsList.push({ id: doc.id, data: s });
            const lv = s.levels || {c1:0, c2:0, c3:0};
            
            gridHtml += `
                <div class="student-grid-item" data-student-id="${doc.id}">
                    <div class="student-grid-header">
                        <span class="student-grid-name">${s.name}</span>
                        <span class="student-grid-id">#${doc.id.slice(-4)}</span>
                    </div>
                    
                    <!-- Attendance Toggle -->
                    <div class="attendance-toggle">
                        <button type="button" class="att-toggle-btn" data-value="P" onclick="setAttendance('${doc.id}', 'P', event)">‚úÖ Present</button>
                        <button type="button" class="att-toggle-btn" data-value="A" onclick="setAttendance('${doc.id}', 'A', event)">‚ùå Absent</button>
                        <button type="button" class="att-toggle-btn" data-value="L" onclick="setAttendance('${doc.id}', 'L', event)">‚è∞ Late</button>
                    </div>
                    <input type="hidden" id="att-${doc.id}" value="P">
                    
                    <!-- Subjects -->
                    ${[0,1,2].map(i => `
                        <div class="subject-row">
                            <span class="subject-label">${labels[i]}</span>
                            <input type="number" class="subject-level" id="level-${doc.id}-${i}" 
                                   value="${lv[`c${i+1}`]}" min="0" placeholder="Level" 
                                   oninput="validateInput(this)" onchange="updateProgress('${doc.id}')">
                            <select class="subject-page" id="page-${doc.id}-${i}" onchange="updateProgress('${doc.id}')">
                                <option value="-">-</option>
                                ${generatePageOptions(maxPages, '-')}
                            </select>
                        </div>
                    `).join('')}
                    
                    <!-- Performance Quick Select -->
                    <div class="performance-quick">
                        <button type="button" class="perf-quick-btn" data-value="Excellent" onclick="setPerformance('${doc.id}', 'Excellent', event)">‚ú® Excellent</button>
                        <button type="button" class="perf-quick-btn" data-value="Good" onclick="setPerformance('${doc.id}', 'Good', event)">üëç Good</button>
                        <button type="button" class="perf-quick-btn" data-value="Average" onclick="setPerformance('${doc.id}', 'Average', event)">üëå Average</button>
                        <button type="button" class="perf-quick-btn" data-value="Poor" onclick="setPerformance('${doc.id}', 'Poor', event)">‚ö†Ô∏è Poor</button>
                    </div>
                    <input type="hidden" id="perf-${doc.id}" value="Good">
                    
                    <!-- Progress Summary -->
                    <div class="progress-summary" id="summary-${doc.id}">
                        <div class="progress-row">
                            <span>üìä Current:</span>
                            <span>${labels[0]}: ${lv.c1} | ${labels[1]}: ${lv.c2} | ${labels[2]}: ${lv.c3}</span>
                        </div>
                    </div>
                </div>
            `;
        });
        
        gridHtml += '</div>';
        container.innerHTML = gridHtml;
        
        // Load any saved draft
        loadDraft();
    }

    // Generate page options
    function generatePageOptions(maxPages, selected) {
        let options = '';
        for(let p=1; p<=maxPages; p++) {
            if (maxPages > 100 && p % 5 !== 0 && p !== maxPages && p !== 1) continue;
            options += `<option value="${p}" ${selected == p ? 'selected' : ''}>${p}</option>`;
        }
        return options;
    }

    // Set attendance for a student
    window.setAttendance = (studentId, value, event) => {
        document.getElementById(`att-${studentId}`).value = value;
        
        // Update button styles
        const container = event.target.closest('.attendance-toggle');
        container.querySelectorAll('.att-toggle-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.value === value) {
                btn.classList.add('active');
            }
        });
        
        triggerAutoSave();
    };

    // Set performance for a student
    window.setPerformance = (studentId, value, event) => {
        document.getElementById(`perf-${studentId}`).value = value;
        
        // Update button styles
        const container = event.target.closest('.performance-quick');
        container.querySelectorAll('.perf-quick-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.value === value) {
                btn.classList.add('active');
            }
        });
        
        triggerAutoSave();
    };

    // Set all students to same attendance
    window.setAllAttendance = (value) => {
        studentsList.forEach(student => {
            document.getElementById(`att-${student.id}`).value = value;
            
            // Update button styles
            const studentCard = document.querySelector(`[data-student-id="${student.id}"]`);
            const container = studentCard.querySelector('.attendance-toggle');
            container.querySelectorAll('.att-toggle-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.value === value) {
                    btn.classList.add('active');
                }
            });
        });
        
        showToast(`All students marked as ${value === 'P' ? 'Present' : value === 'A' ? 'Absent' : 'Late'}`);
        triggerAutoSave();
    };

    // Set all students to same performance
    window.setAllPerformance = (value) => {
        studentsList.forEach(student => {
            document.getElementById(`perf-${student.id}`).value = value;
            
            // Update button styles
            const studentCard = document.querySelector(`[data-student-id="${student.id}"]`);
            const container = studentCard.querySelector('.performance-quick');
            container.querySelectorAll('.perf-quick-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.value === value) {
                    btn.classList.add('active');
                }
            });
        });
        
        showToast(`All students set to ${value}`);
        triggerAutoSave();
    };

    // Reset all page numbers to default
    window.resetPageNumbers = () => {
        if (confirm('Reset all page numbers to "-"?')) {
            studentsList.forEach(student => {
                for(let i=0; i<3; i++) {
                    const pageSelect = document.getElementById(`page-${student.id}-${i}`);
                    if (pageSelect) pageSelect.value = '-';
                }
            });
            showToast('All pages reset');
            triggerAutoSave();
        }
    };

    // Update progress summary
    window.updateProgress = (studentId) => {
        const summary = document.getElementById(`summary-${studentId}`);
        const labels = divisionLabels[teacherData.division] || ["S1", "S2", "S3"];
        
        const levels = [];
        for(let i=0; i<3; i++) {
            const levelInput = document.getElementById(`level-${studentId}-${i}`);
            levels.push(levelInput ? levelInput.value : '0');
        }
        
        summary.innerHTML = `
            <div class="progress-row">
                <span>üìä Current:</span>
                <span>${labels[0]}: ${levels[0]} | ${labels[1]}: ${levels[1]} | ${labels[2]}: ${levels[2]}</span>
            </div>
        `;
        
        triggerAutoSave();
    };

    // Validate input
    window.validateInput = (input) => {
        const val = parseInt(input.value);
        if (val < 0) {
            input.classList.add('error');
            return false;
        } else {
            input.classList.remove('error');
            return true;
        }
    };

    // Auto-save
    let autoSaveTimer;
    function triggerAutoSave() {
        clearTimeout(autoSaveTimer);
        autoSaveTimer = setTimeout(() => {
            saveDraft();
            showToast('üìù Draft saved');
        }, 2000);
    }

    // Save draft to localStorage
    function saveDraft() {
        const draft = {};
        studentsList.forEach(student => {
            const sid = student.id;
            const att = document.getElementById(`att-${sid}`)?.value || 'P';
            const perf = document.getElementById(`perf-${sid}`)?.value || 'Good';
            
            const levels = [];
            const pages = [];
            for(let i=0; i<3; i++) {
                const levelInput = document.getElementById(`level-${sid}-${i}`);
                const pageSelect = document.getElementById(`page-${sid}-${i}`);
                levels.push(levelInput ? levelInput.value : '0');
                pages.push(pageSelect ? pageSelect.value : '-');
            }
            
            draft[sid] = { att, perf, levels, pages };
        });
        
        localStorage.setItem('teacherDraft', JSON.stringify({
            date: document.getElementById('batchDate')?.value,
            data: draft
        }));
    }

    // Load draft from localStorage
    function loadDraft() {
        const draft = JSON.parse(localStorage.getItem('teacherDraft'));
        if (!draft || !draft.data) return;
        
        const currentDate = document.getElementById('batchDate')?.value;
        
        if (draft.date === currentDate) {
            Object.entries(draft.data).forEach(([sid, values]) => {
                // Set attendance
                const attInput = document.getElementById(`att-${sid}`);
                if (attInput) {
                    attInput.value = values.att || 'P';
                    
                    // Update button styles
                    const studentCard = document.querySelector(`[data-student-id="${sid}"]`);
                    if (studentCard) {
                        const attContainer = studentCard.querySelector('.attendance-toggle');
                        attContainer.querySelectorAll('.att-toggle-btn').forEach(btn => {
                            btn.classList.remove('active');
                            if (btn.dataset.value === values.att) {
                                btn.classList.add('active');
                            }
                        });
                    }
                }
                
                // Set performance
                const perfInput = document.getElementById(`perf-${sid}`);
                if (perfInput) {
                    perfInput.value = values.perf || 'Good';
                    
                    const studentCard = document.querySelector(`[data-student-id="${sid}"]`);
                    if (studentCard) {
                        const perfContainer = studentCard.querySelector('.performance-quick');
                        perfContainer.querySelectorAll('.perf-quick-btn').forEach(btn => {
                            btn.classList.remove('active');
                            if (btn.dataset.value === values.perf) {
                                btn.classList.add('active');
                            }
                        });
                    }
                }
                
                // Set levels and pages
                if (values.levels) {
                    values.levels.forEach((level, i) => {
                        const levelInput = document.getElementById(`level-${sid}-${i}`);
                        if (levelInput) levelInput.value = level;
                    });
                }
                
                if (values.pages) {
                    values.pages.forEach((page, i) => {
                        const pageSelect = document.getElementById(`page-${sid}-${i}`);
                        if (pageSelect) pageSelect.value = page;
                    });
                }
                
                updateProgress(sid);
            });
            
            showToast('üìÇ Draft loaded');
        }
    }

    // Submit all records
    window.submitAllRecords = async () => {
        const logDate = document.getElementById('batchDate').value;
        
        if (!logDate) { 
            showToast("‚ö†Ô∏è Please select a date");
            return; 
        }
        
        // Validate inputs
        let hasError = false;
        document.querySelectorAll('.subject-level').forEach(input => {
            if (parseInt(input.value) < 0) {
                input.classList.add('error');
                hasError = true;
            }
        });
        
        if (hasError) {
            showToast("‚ö†Ô∏è Please fix negative values");
            return;
        }
        
        const confirmSave = confirm(`Submit records for ${studentsList.length} students?`);
        if (!confirmSave) return;

        const btn = document.getElementById('submitAllBtn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span> Saving...';

        try {
            const labels = divisionLabels[teacherData.division] || ["S1", "S2", "S3"];
            let successCount = 0;
            
            for (let student of studentsList) {
                const sid = student.id;
                
                // Get values
                const att = document.getElementById(`att-${sid}`)?.value || 'P';
                const perf = document.getElementById(`perf-${sid}`)?.value || 'Good';
                
                const lv = {c1:0, c2:0, c3:0};
                const pages = {p1:'-', p2:'-', p3:'-'};
                
                for(let i=0; i<3; i++) {
                    const levelInput = document.getElementById(`level-${sid}-${i}`);
                    const pageSelect = document.getElementById(`page-${sid}-${i}`);
                    
                    if (levelInput) lv[`c${i+1}`] = parseInt(levelInput.value) || 0;
                    if (pageSelect) pages[`p${i+1}`] = pageSelect.value;
                }
                
                // Create log text (same format for compatibility)
                const logText = `[ATTN: ${att}] [${perf}] ${labels[0]}: LVL ${lv.c1} PG ${pages.p1} | ${labels[1]}: LVL ${lv.c2} PG ${pages.p2} | ${labels[2]}: LVL ${lv.c3} PG ${pages.p3}`;
                
                // Update Firebase
                const sRef = doc(db, "students", sid);
                const sSnap = await getDoc(sRef);
                const currentLogs = sSnap.data().logs || [];
                
                await updateDoc(sRef, {
                    levels: lv,
                    logs: [{ date: logDate, text: logText, timestamp: new Date() }, ...currentLogs].slice(0, 100)
                });
                
                successCount++;
            }
            
            // Clear draft after successful save
            localStorage.removeItem('teacherDraft');
            
            showToast(`‚úÖ Success! ${successCount} records saved.`);
            window.switchTab('dashboard');
            
        } catch (e) { 
            showToast("‚ùå Error: " + e.message); 
        } finally {
            btn.disabled = false;
            btn.innerHTML = "üíæ Save All Records";
        }
    };

    // Show toast notification
    function showToast(message) {
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 2000);
    }

    // History functions
    async function populateHistoryDropdown() {
        const sel = document.getElementById('historyStudentSelect');
        const q = query(collection(db, "students"), where("division", "==", teacherData.division));
        const snap = await getDocs(q);
        sel.innerHTML = '<option value="">-- Choose Student --</option>' + 
            snap.docs.map(d => `<option value="${d.id}">${d.data().name}</option>`).join('');
        sel.onchange = loadStudentHistory;
        document.getElementById('historyMonthFilter').onchange = loadStudentHistory;
    }

    async function loadStudentHistory() {
        const sid = document.getElementById('historyStudentSelect').value;
        const monthFilter = document.getElementById('historyMonthFilter').value;
        const res = document.getElementById('historyResult');
        
        if(!sid) {
            res.innerHTML = '<p style="color:#666; text-align:center; padding:20px;">Select a student to view records</p>';
            return;
        }

        const sDoc = await getDoc(doc(db, "students", sid));
        let logs = sDoc.data().logs || [];
        const labels = divisionLabels[teacherData.division] || ["S1", "S2", "S3"];

        if (monthFilter !== 'all') {
            logs = logs.filter(log => log.date && log.date.split('-')[1] === monthFilter);
        }

        if (!logs.length) {
            res.innerHTML = "<p style='text-align:center; padding:20px;'>No records found</p>";
            return;
        }

        let tableHtml = `
            <table class="hist-table">
                <thead>
                    <tr>
                        <th>DATE</th>
                        <th>ATTN</th>
                        <th colspan="2">${labels[0]}</th>
                        <th colspan="2">${labels[1]}</th>
                        <th colspan="2">${labels[2]}</th>
                        <th>Perf.</th>
                    </tr>
                    <tr>
                        <th></th>
                        <th></th>
                        <th>LVL</th><th>PG</th>
                        <th>LVL</th><th>PG</th>
                        <th>LVL</th><th>PG</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>`;

        logs.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(log => {
            const attnMatch = log.text.match(/\[Attn: (.*?)\]/);
            const perfMatch = log.text.match(/\] \[(.*?)\]/);
            const attn = attnMatch ? attnMatch[1] : "-";
            const perf = perfMatch ? perfMatch[1] : "-";
            const progressParts = log.text.split('|');
            
            const extractData = (part) => {
                if(!part) return { LVL: "-", PG: "-" };
                const lMatch = part.match(/LVL (.*?) /);
                const pMatch = part.match(/PG (.*?)$/);
                return { LVL: lMatch ? lMatch[1] : "-", PG: pMatch ? pMatch[1] : "-" };
            };

            const s1 = extractData(progressParts[0]);
            const s2 = extractData(progressParts[1]);
            const s3 = extractData(progressParts[2]);

            tableHtml += `
                <tr>
                    <td>${log.date}</td>
                    <td><span class="attn-badge attn-${attn}">${attn}</span></td>
                    <td>${s1.LVL}</td><td>${s1.PG}</td>
                    <td>${s2.LVL}</td><td>${s2.PG}</td>
                    <td>${s3.LVL}</td><td>${s3.PG}</td>
                    <td><span class="attn-badge" style="background:#e3f2fd;">${perf}</span></td>
                </tr>`;
        });

        tableHtml += `</tbody></table>`;
        res.innerHTML = tableHtml;
    }

    async function loadNotice() {
        const q = query(collection(db, "notices"), orderBy("timestamp", "desc"), limit(1));
        const snap = await getDocs(q);
        if (!snap.empty) {
            document.getElementById('noticeBar').style.display = 'block';
            document.getElementById('noticeText').innerText = snap.docs[0].data().message;
        }
    }

    window.logout = () => { 
        localStorage.clear(); 
        window.location.href = 'index.html'; 
    };

    // Start the app
    init();
</script>
</body>
</html>
