<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Teacher Portal | Makki Masjid Gakuin</title>
    <style>
        :root { 
            --primary: #004d40; 
            --primary-light: #338573;
            --gold: #d4af37; 
            --bg: #f4f7f6;
            --danger: #c62828;
            --success: #2e7d32;
            --warning: #ef6c00;
            --info: #0288d1;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body { 
            background: var(--bg); 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif; 
            margin: 0; 
            line-height: 1.5;
        }
        
        .teacher-container { 
            max-width: 1100px; 
            margin: 10px auto; 
            padding: 10px; 
        }
        
        /* Header */
        .header { 
            background: linear-gradient(135deg, var(--primary) 0%, #00695c 100%);
            color: white; 
            padding: 20px; 
            border-radius: 16px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
        }
        
        .header h1 { 
            margin: 0; 
            font-size: 1.3rem; 
        }
        
        .header p {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-top: 5px;
        }
        
        /* Sections */
        .section { 
            background: white; 
            padding: 20px; 
            border-radius: 16px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
            margin-top: 15px; 
        }
        
        .section h3 { 
            color: var(--primary); 
            border-bottom: 2px solid var(--bg); 
            padding-bottom: 12px; 
            margin-top: 0; 
            margin-bottom: 20px;
            font-size: 1.2rem;
        }
        
        /* Tables */
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 10px; 
        }
        
        th { 
            text-align: left; 
            padding: 12px; 
            background: #f8f9fa; 
            color: #333; 
            font-size: 0.75rem; 
            text-transform: uppercase; 
            border: 1px solid #ddd; 
        }
        
        td { 
            padding: 10px; 
            border: 1px solid #eee; 
            word-wrap: break-word; 
        }
        
        /* Tabs */
        .tab-container {
            margin-top: 20px;
            display: flex;
            gap: 5px;
            border-bottom: 2px solid #ddd;
            padding-bottom: 0;
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
        }
        
        .tab-btn { 
            padding: 12px 16px; 
            border: none; 
            border-radius: 12px 12px 0 0; 
            cursor: pointer; 
            background: #e0e0e0; 
            font-weight: 600; 
            transition: all 0.3s; 
            font-size: 0.9rem;
            min-width: 100px;
        }
        
        .tab-btn.active { 
            background: var(--primary); 
            color: white; 
        }
        
        .tab-content { 
            display: none; 
        }
        
        .tab-content.active { 
            display: block; 
        }
        
        /* Buttons */
        .btn-logout { 
            background: rgba(255,255,255,0.2); 
            color: white; 
            border: 1px solid rgba(255,255,255,0.3); 
            padding: 10px 16px; 
            border-radius: 30px; 
            cursor: pointer; 
            font-weight: 600;
            backdrop-filter: blur(5px);
            transition: all 0.3s;
        }
        
        .btn-logout:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .btn-submit { 
            background: linear-gradient(135deg, var(--primary) 0%, #00695c 100%);
            color: white; 
            border: none; 
            padding: 16px; 
            width: 100%; 
            border-radius: 12px; 
            cursor: pointer; 
            font-size: 1.1rem; 
            font-weight: bold; 
            margin-top: 20px; 
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0,77,64,0.3);
        }
        
        .btn-submit:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,77,64,0.4);
        }
        
        .btn-submit:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-ghost {
            background: white;
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 10px 16px;
            border-radius: 30px;
            cursor: pointer;
            font-weight: 600;
            margin-bottom: 15px;
            transition: all 0.3s;
        }
        
        .btn-ghost:hover {
            background: var(--primary);
            color: white;
        }
        
        /* Progress Bars */
        .progress-bar-bg { 
            background: #eee; 
            height: 6px; 
            border-radius: 3px; 
            width: 100%; 
            display: inline-block; 
        }
        
        .progress-fill { 
            background: var(--gold); 
            height: 100%; 
            border-radius: 3px; 
        }
        
        /* Attendance Badges */
        .attn-badge { 
            padding: 4px 8px; 
            border-radius: 20px; 
            font-weight: bold; 
            font-size: 0.8rem; 
            display: inline-block; 
            text-align: center; 
            min-width: 30px;
        }
        
        .attn-P { 
            background: #e8f5e9; 
            color: #2e7d32; 
        }
        
        .attn-A { 
            background: #ffebee; 
            color: #c62828; 
        }
        
        .attn-L { 
            background: #fff3e0; 
            color: #ef6c00; 
        }
        
        /* Mobile-Friendly Input Styles */
        .mobile-friendly-input {
            padding: 5px;
        }
        
        .date-selector {
            margin-bottom: 20px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 12px;
        }
        
        .date-selector label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--primary);
        }
        
        .mobile-date-input {
            width: 100%;
            padding: 14px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1rem;
            font-family: inherit;
        }
        
        .mobile-date-input:focus {
            border-color: var(--primary);
            outline: none;
        }
        
        .student-cards {
            margin-top: 15px;
        }
        
        .student-card {
            background: white;
            border-radius: 20px;
            padding: 18px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border-left: 5px solid var(--primary);
            border: 1px solid #eee;
            transition: transform 0.2s;
        }
        
        .student-card:active {
            transform: scale(0.99);
        }
        
        .student-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .student-name {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--primary);
        }
        
        .student-id {
            background: var(--bg);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            color: #666;
        }
        
        /* Quick Attendance Buttons */
        .attendance-quick {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .attn-btn {
            flex: 1;
            padding: 14px 8px;
            border: 2px solid transparent;
            border-radius: 12px;
            font-weight: bold;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            background: #f5f5f5;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .attn-btn.present.active {
            background: #e8f5e9;
            color: #2e7d32;
            border-color: #2e7d32;
        }
        
        .attn-btn.absent.active {
            background: #ffebee;
            color: #c62828;
            border-color: #c62828;
        }
        
        .attn-btn.late.active {
            background: #fff3e0;
            color: #ef6c00;
            border-color: #ef6c00;
        }
        
        /* Subject Progress Cards */
        .subject-progress {
            background: #f8f9fa;
            border-radius: 16px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .subject-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-weight: 600;
            color: var(--primary);
            font-size: 1rem;
        }
        
        .current-level {
            background: var(--primary-light);
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
        }
        
        .progress-inputs {
            display: flex;
            gap: 10px;
        }
        
        .progress-inputs select,
        .progress-inputs input {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1rem;
            background: white;
            font-family: inherit;
        }
        
        .progress-inputs input:focus,
        .progress-inputs select:focus {
            border-color: var(--primary);
            outline: none;
        }
        
        .progress-inputs input.error {
            border-color: var(--danger);
            background: #ffebee;
        }
        
        /* Performance Rating */
        .performance-rating {
            margin-top: 15px;
        }
        
        .performance-rating label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--primary);
        }
        
        .rating-buttons {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        
        .rating-btn {
            flex: 1;
            min-width: 70px;
            padding: 12px 6px;
            border: 2px solid transparent;
            border-radius: 12px;
            background: #f5f5f5;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            color: #333;
        }
        
        .rating-btn.excellent.active { 
            background: #4caf50; 
            color: white; 
            border-color: #2e7d32;
        }
        .rating-btn.good.active { 
            background: #2196f3; 
            color: white; 
            border-color: #1565c0;
        }
        .rating-btn.average.active { 
            background: #ff9800; 
            color: white; 
            border-color: #c66900;
        }
        .rating-btn.poor.active { 
            background: #f44336; 
            color: white; 
            border-color: #c62828;
        }
        
        /* Student Counter */
        .student-counter {
            text-align: center;
            padding: 12px;
            background: var(--primary);
            color: white;
            border-radius: 30px;
            margin: 15px 0;
            font-weight: bold;
            font-size: 0.95rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary);
            color: white;
            padding: 12px 24px;
            border-radius: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 9999;
            animation: slideUp 0.3s ease;
            font-weight: 500;
        }
        
        @keyframes slideUp {
            from {
                transform: translate(-50%, 100%);
                opacity: 0;
            }
            to {
                transform: translate(-50%, 0);
                opacity: 1;
            }
        }
        
        /* Spinner */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
            vertical-align: middle;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Filter Container */
        .filter-container { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 20px; 
            flex-wrap: wrap; 
        }
        
        .filter-container select { 
            padding: 14px; 
            border-radius: 10px; 
            border: 2px solid #ddd; 
            flex: 1; 
            min-width: 200px; 
            font-size: 1rem;
            background: white;
        }
        
        .filter-container select:focus {
            border-color: var(--primary);
            outline: none;
        }
        
        /* Notice Bar */
        #noticeBar {
            background: #fff3cd;
            padding: 15px;
            border-radius: 12px;
            margin-top: 15px;
            border-left: 5px solid var(--gold);
            font-weight: bold;
            color: #856404;
        }
        
        /* History Table */
        .hist-table th { 
            text-align: center !important; 
            color: white !important; 
            background: var(--primary); 
            padding: 12px 5px;
            font-size: 0.75rem;
        }
        
        .hist-table td { 
            text-align: center; 
            font-size: 0.85rem; 
            padding: 8px 3px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .tab-container {
                flex-wrap: nowrap;
                justify-content: flex-start;
            }
            
            .tab-btn {
                min-width: 90px;
                padding: 10px 12px;
                font-size: 0.8rem;
            }
            
            .student-name {
                font-size: 1.1rem;
            }
            
            .attn-btn {
                padding: 12px 4px;
                font-size: 0.8rem;
            }
            
            .rating-btn {
                font-size: 0.75rem;
                padding: 10px 4px;
            }
            
            .progress-inputs {
                flex-direction: column;
                gap: 8px;
            }
            
            .progress-inputs select,
            .progress-inputs input {
                width: 100%;
            }
        }
    </style>
</head>
<body>

<div class="teacher-container">
    <div class="header">
        <div>
            <h1 id="teacherGreeting">Assalamu Alaikum</h1>
            <p id="divisionInfo">Division: Loading...</p>
        </div>
        <button class="btn-logout" onclick="logout()">üö™ Logout</button>
    </div>

    <div id="noticeBar" style="display:none;">
        <marquee id="noticeText" behavior="scroll" direction="left"></marquee>
    </div>

    <div class="tab-container">
        <button class="tab-btn active" id="btn-dashboard" onclick="switchTab('dashboard')">üìä Progress</button>
        <button class="tab-btn" id="btn-inputTab" onclick="switchTab('inputTab')">‚úçÔ∏è Daily Input</button>
        <button class="tab-btn" id="btn-historyTab" onclick="switchTab('historyTab')">üìú History</button>
    </div>

    <!-- Dashboard Tab -->
    <div id="dashboard" class="tab-content active">
        <div class="section">
            <h3>üìñ Student Progress Overview</h3>
            <div style="overflow-x: auto;">
                <table id="progressTable">
                    <thead>
                        <tr><th style="width: 30%;">Student Name</th><th>Level Progress</th></tr>
                    </thead>
                    <tbody id="myStudentList">
                        <tr><td colspan="2" style="text-align:center;">Loading students...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Daily Input Tab (Mobile Friendly) -->
    <div id="inputTab" class="tab-content">
        <div class="section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0;">üìù Daily Log Entry</h3>
                <button class="btn-ghost" id="toggleViewBtn" onclick="toggleViewMode()">üîÑ Switch to Table View</button>
            </div>
            
            <!-- Mobile-Friendly Input Container -->
            <div id="mobileFriendlyInput" class="mobile-friendly-input">
                <!-- Dynamically populated by JavaScript -->
            </div>
            
            <!-- Hidden Table View (kept for compatibility and switching) -->
            <div id="tableView" style="display: none;">
                <div style="overflow-x: auto;">
                    <table style="min-width:1100px; font-size: 0.85rem;">
                        <thead>
                            <tr style="background:#f8f9fa;">
                                <th style="width:40px;">Sl</th>
                                <th style="width:150px;">Name</th>
                                <th style="width:70px;">Attn</th>
                                <th colspan="2" id="h-s1" style="background:#e3f2fd; text-align:center;">S1</th>
                                <th colspan="2" id="h-s2" style="background:#f1f8e9; text-align:center;">S2</th>
                                <th colspan="2" id="h-s3" style="background:#fff3e0; text-align:center;">S3</th>
                                <th style="width:120px;">Perf.</th>
                            </tr>
                            <tr style="font-size:0.7rem; background:#eee;">
                                <th colspan="3"></th>
                                <th style="text-align:center;">Lvl</th>
                                <th style="text-align:center;">Page</th>
                                <th style="text-align:center;">Lvl</th>
                                <th style="text-align:center;">Page</th>
                                <th style="text-align:center;">Lvl</th>
                                <th style="text-align:center;">Page</th>
                                <th style="text-align:center;">Remark</th>
                            </tr>
                        </thead>
                        <tbody id="batchTableBody"></tbody>
                    </table>
                </div>
                <button class="btn-submit" id="saveAllBtn" onclick="saveAllBatch()">Submit All Records</button>
            </div>
        </div>
    </div>

    <!-- History Tab -->
    <div id="historyTab" class="tab-content">
        <div class="section">
            <h3>üìú Monthly Academic Record</h3>
            <div class="filter-container">
                <select id="historyStudentSelect">
                    <option value="">-- Choose Student --</option>
                </select>
                <select id="historyMonthFilter">
                    <option value="all">Show All Months</option>
                    <option value="01">January</option>
                    <option value="02">February</option>
                    <option value="03">March</option>
                    <option value="04">April</option>
                    <option value="05">May</option>
                    <option value="06">June</option>
                    <option value="07">July</option>
                    <option value="08">August</option>
                    <option value="09">September</option>
                    <option value="10">October</option>
                    <option value="11">November</option>
                    <option value="12">December</option>
                </select>
            </div>
            <div id="historyResult" style="overflow-x: auto;">
                <p style="color:#666; text-align:center; padding:20px;">Select a student to view the academic table.</p>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, getDocs, collection, query, where, updateDoc, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAdA02h0pqEEQunobeSM4emZfPW1EjMKu4",
        authDomain: "makki-masjid-gakuin.firebaseapp.com",
        projectId: "makki-masjid-gakuin",
        storageBucket: "makki-masjid-gakuin.firebasestorage.app",
        messagingSenderId: "376596641128",
        appId: "1:376596641128:web:b49c1233aaed64ae6552dd"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const divisionLabels = {
        "Maktab": ["Qaida", "Dua", "Islamic Studies"],
        "Nazera": ["Para", "Tajweed", "Islamic Studies"],
        "Hifz": ["Para", "Tajweed", "Islamic Studies"]
    };

    const teacherEmail = localStorage.getItem('userEmail');
    let teacherData = null;
    let viewMode = 'mobile'; // 'mobile' or 'table'
    let autoSaveTimer;
    let currentStudentIndex = 0;

    // Initialize
    async function init() {
        if (!teacherEmail) { 
            window.location.href = 'index.html'; 
            return; 
        }
        try {
            const tDoc = await getDoc(doc(db, "users", teacherEmail));
            if (tDoc.exists()) {
                teacherData = tDoc.data();
                document.getElementById('teacherGreeting').innerText = "Assalamu Alaikum, " + (teacherData.name || "Teacher");
                document.getElementById('divisionInfo').innerText = "Division: " + (teacherData.division || "Not Assigned");
                loadNotice();
                loadStudents();
            } else {
                alert("Teacher profile not found.");
            }
        } catch (err) {
            console.error("Init Error:", err);
        }
    }

    // Tab Switching
    window.switchTab = (tabId) => {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        document.getElementById('btn-' + tabId).classList.add('active');
        
        if(tabId === 'dashboard') loadStudents();
        if(tabId === 'inputTab') {
            if (viewMode === 'mobile') {
                renderMobileFriendlyInput();
            } else {
                renderTableInput();
            }
        }
        if(tabId === 'historyTab') populateHistoryDropdown();
    };

    // Toggle between mobile and table view
    window.toggleViewMode = () => {
        viewMode = viewMode === 'mobile' ? 'table' : 'mobile';
        const toggleBtn = document.getElementById('toggleViewBtn');
        toggleBtn.innerHTML = viewMode === 'mobile' ? 'üîÑ Switch to Table View' : 'üîÑ Switch to Card View';
        
        if (viewMode === 'mobile') {
            document.getElementById('mobileFriendlyInput').style.display = 'block';
            document.getElementById('tableView').style.display = 'none';
            renderMobileFriendlyInput();
        } else {
            document.getElementById('mobileFriendlyInput').style.display = 'none';
            document.getElementById('tableView').style.display = 'block';
            renderTableInput();
        }
    };

    // Load students for dashboard
    async function loadStudents() {
        const list = document.getElementById('myStudentList');
        if (!teacherData || !teacherData.division) return;
        
        const q = query(collection(db, "students"), where("division", "==", teacherData.division));
        const snap = await getDocs(q);
        list.innerHTML = "";
        
        if (snap.empty) {
            list.innerHTML = '<tr><td colspan="2" style="text-align:center;">No students found</td></tr>';
            return;
        }
        
        const labels = divisionLabels[teacherData.division] || ["S1", "S2", "S3"];
        snap.forEach(docSnap => {
            const s = docSnap.data();
            const lv = s.levels || { c1: 0, c2: 0, c3: 0 };
            const gl = s.goals || { c1: 1, c2: 1, c3: 1 };
            
            const createBar = (cur, goal, lbl) => {
                const perc = Math.min(Math.round((cur / (goal || 1)) * 100), 100);
                return `<div style="margin-bottom:8px;">
                            <div style="display:flex; justify-content:space-between; font-size:11px;">
                                <strong>${lbl}</strong> <span>${cur}/${goal}</span>
                            </div>
                            <div class="progress-bar-bg"><div class="progress-fill" style="width:${perc}%"></div></div>
                        </div>`;
            };
            
            const tr = document.createElement('tr');
            tr.innerHTML = `<td><strong>${s.name}</strong></td>
                            <td>${createBar(lv.c1, gl.c1, labels[0])} 
                                ${createBar(lv.c2, gl.c2, labels[1])} 
                                ${createBar(lv.c3, gl.c3, labels[2])}</td>`;
            list.appendChild(tr);
        });
    }

    // Render Mobile-Friendly Input
    async function renderMobileFriendlyInput() {
        const container = document.getElementById('mobileFriendlyInput');
        const labels = divisionLabels[teacherData.division] || ["S1", "S2", "S3"];
        
        // Set date
        const dateHtml = `
            <div class="date-selector">
                <label>üìÖ Select Date</label>
                <input type="date" id="mobileBatchDate" class="mobile-date-input" value="${new Date().toISOString().split('T')[0]}">
            </div>
        `;
        
        // Fetch students
        const q = query(collection(db, "students"), where("division", "==", teacherData.division));
        const snap = await getDocs(q);
        
        if (snap.empty) {
            container.innerHTML = dateHtml + '<p style="text-align:center; padding:20px;">No students found</p>';
            return;
        }
        
        // Generate page options based on division
        const maxPages = teacherData.division === "Hifz" ? 604 : 
                         teacherData.division === "Nazera" ? 604 : 50;
        let pageOptions = '<option value="-">-</option>';
        for(let p=1; p<=maxPages; p++) {
            if (maxPages > 100 && p % 5 !== 0 && p !== maxPages) continue; // Show every 5th page for large ranges
            pageOptions += `<option value="${p}">${p}</option>`;
        }
        
        let cardsHtml = '';
        const students = [];
        
        snap.forEach(doc => {
            students.push({ id: doc.id, data: doc.data() });
        });
        
        // Store students array for navigation
        window.studentsList = students;
        
        students.forEach((student, index) => {
            const s = student.data;
            const lv = s.levels || {c1:0, c2:0, c3:0};
            
            cardsHtml += `
                <div class="student-card" data-sid="${student.id}" data-name="${s.name}" data-index="${index}" 
                     style="${index === 0 ? 'display:block' : 'display:none'}">
                    <div class="student-header">
                        <span class="student-name">${s.name}</span>
                        <span class="student-id">#${student.id.slice(-4)}</span>
                    </div>
                    
                    <div class="attendance-quick">
                        <button type="button" class="attn-btn present" onclick="setAttendance('${student.id}', 'P', event)">‚úÖ Present</button>
                        <button type="button" class="attn-btn absent" onclick="setAttendance('${student.id}', 'A', event)">‚ùå Absent</button>
                        <button type="button" class="attn-btn late" onclick="setAttendance('${student.id}', 'L', event)">‚è∞ Late</button>
                    </div>
                    <input type="hidden" class="attn-${student.id}" value="P">
                    
                    ${[0,1,2].map(i => `
                        <div class="subject-progress">
                            <div class="subject-header">
                                <span>üìö ${labels[i]}</span>
                                <span class="current-level">Current: ${lv[`c${i+1}`]}</span>
                            </div>
                            <div class="progress-inputs">
                                <input type="number" class="level-input-${student.id}-${i}" 
                                       value="${lv[`c${i+1}`]}" placeholder="Level" min="0" step="1" 
                                       oninput="validateInput(this)" onchange="triggerAutoSave()">
                                <select class="page-input-${student.id}-${i}" onchange="triggerAutoSave()">
                                    ${pageOptions}
                                </select>
                            </div>
                        </div>
                    `).join('')}
                    
                    <div class="performance-rating">
                        <label>‚≠ê Performance Today:</label>
                        <div class="rating-buttons">
                            <button type="button" class="rating-btn excellent" onclick="setPerformance('${student.id}', 'Excellent', event)">Excellent</button>
                            <button type="button" class="rating-btn good" onclick="setPerformance('${student.id}', 'Good', event)">Good</button>
                            <button type="button" class="rating-btn average" onclick="setPerformance('${student.id}', 'Average', event)">Average</button>
                            <button type="button" class="rating-btn poor" onclick="setPerformance('${student.id}', 'Poor', event)">Poor</button>
                        </div>
                        <input type="hidden" class="perf-${student.id}" value="Good">
                    </div>
                </div>
            `;
        });
        
        // Add navigation counter
        const counterHtml = `
            <div class="student-counter" id="studentCounter">
                Student 1 of ${students.length} üëà Swipe to navigate üëâ
            </div>
        `;
        
        container.innerHTML = dateHtml + counterHtml + cardsHtml + `
            <button class="btn-submit" id="mobileSaveBtn" onclick="saveAllBatch()">
                ‚úÖ Submit All Records
            </button>
        `;
        
        // Setup swipe navigation
        setupSwipeNavigation();
        
        // Load draft if exists
        loadDraft();
    }

    // Render Table Input (original view)
    async function renderTableInput() {
        const tbody = document.getElementById('batchTableBody');
        document.getElementById('batchDate').valueAsDate = new Date();
        const labels = divisionLabels[teacherData.division] || ["S1", "S2", "S3"];
        document.getElementById('h-s1').innerText = labels[0];
        document.getElementById('h-s2').innerText = labels[1];
        document.getElementById('h-s3').innerText = labels[2];

        const q = query(collection(db, "students"), where("division", "==", teacherData.division));
        const snap = await getDocs(q);
        
        let pageOptions = `<option value="-">-</option>`;
        const maxPages = teacherData.division === "Hifz" ? 604 : 
                         teacherData.division === "Nazera" ? 604 : 50;
        for(let p=1; p<=maxPages; p++) {
            if (maxPages > 100 && p % 5 !== 0 && p !== maxPages) continue;
            pageOptions += `<option value="${p}">${p}</option>`;
        }

        let html = "";
        let i = 1;
        snap.forEach(doc => {
            const s = doc.data();
            const lv = s.levels || {c1:0, c2:0, c3:0};
            html += `<tr data-sid="${doc.id}" data-name="${s.name}">
                <td style="text-align:center;">${i++}</td>
                <td><strong>${s.name}</strong></td>
                <td>
                    <select class="batch-input attn">
                        <option value="P">P</option>
                        <option value="A">A</option>
                        <option value="L">L</option>
                    </select>
                </td>
                <td><input type="number" class="batch-input l1" value="${lv.c1}" min="0"></td>
                <td><select class="batch-input p1">${pageOptions}</select></td>
                <td><input type="number" class="batch-input l2" value="${lv.c2}" min="0"></td>
                <td><select class="batch-input p2">${pageOptions}</select></td>
                <td><input type="number" class="batch-input l3" value="${lv.c3}" min="0"></td>
                <td><select class="batch-input p3">${pageOptions}</select></td>
                <td>
                    <select class="batch-input perf">
                        <option value="Excellent">Excellent</option>
                        <option value="Good" selected>Good</option>
                        <option value="Average">Average</option>
                        <option value="Poor">Poor</option>
                    </select>
                </td>
            </tr>`;
        });
        tbody.innerHTML = html;
    }

    // Mobile Helper Functions
    window.setAttendance = (studentId, value, event) => {
        document.querySelector(`.attn-${studentId}`).value = value;
        
        // Update button styles
        const parent = event.target.closest('.attendance-quick');
        parent.querySelectorAll('.attn-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
        triggerAutoSave();
    };

    window.setPerformance = (studentId, value, event) => {
        document.querySelector(`.perf-${studentId}`).value = value;
        
        // Update button styles
        const parent = event.target.closest('.rating-buttons');
        parent.querySelectorAll('.rating-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
        triggerAutoSave();
    };

    window.validateInput = (input) => {
        const val = parseInt(input.value);
        if (val < 0) {
            input.classList.add('error');
            return false;
        } else {
            input.classList.remove('error');
            return true;
        }
    };

    // Auto-save draft
    window.triggerAutoSave = () => {
        clearTimeout(autoSaveTimer);
        autoSaveTimer = setTimeout(() => {
            saveDraft();
            showToast('üìù Draft saved');
        }, 2000);
    };

    function saveDraft() {
        if (!window.studentsList) return;
        
        const draft = {};
        window.studentsList.forEach(student => {
            const sid = student.id;
            const attn = document.querySelector(`.attn-${sid}`)?.value || 'P';
            const perf = document.querySelector(`.perf-${sid}`)?.value || 'Good';
            
            const levels = {};
            for(let i=0; i<3; i++) {
                const levelInput = document.querySelector(`.level-input-${sid}-${i}`);
                const pageSelect = document.querySelector(`.page-input-${sid}-${i}`);
                if (levelInput) levels[`c${i+1}`] = levelInput.value;
                if (pageSelect) levels[`p${i+1}`] = pageSelect.value;
            }
            
            draft[sid] = { attn, perf, ...levels };
        });
        
        localStorage.setItem('teacherDraft', JSON.stringify({
            date: document.getElementById('mobileBatchDate')?.value,
            data: draft
        }));
    }

    function loadDraft() {
        const draft = JSON.parse(localStorage.getItem('teacherDraft'));
        if (!draft || !draft.data) return;
        
        const draftDate = draft.date;
        const currentDate = document.getElementById('mobileBatchDate')?.value;
        
        if (draftDate === currentDate) {
            Object.entries(draft.data).forEach(([sid, values]) => {
                // Set attendance
                const attnInput = document.querySelector(`.attn-${sid}`);
                if (attnInput) {
                    attnInput.value = values.attn || 'P';
                    // Highlight active button
                    const attnBtn = document.querySelector(`.attn-btn.${values.attn === 'P' ? 'present' : values.attn === 'A' ? 'absent' : 'late'}`);
                    if (attnBtn) attnBtn.classList.add('active');
                }
                
                // Set performance
                const perfInput = document.querySelector(`.perf-${sid}`);
                if (perfInput) {
                    perfInput.value = values.perf || 'Good';
                    const perfBtn = document.querySelector(`.rating-btn.${values.perf?.toLowerCase()}`);
                    if (perfBtn) perfBtn.classList.add('active');
                }
                
                // Set levels and pages
                for(let i=0; i<3; i++) {
                    const levelInput = document.querySelector(`.level-input-${sid}-${i}`);
                    const pageSelect = document.querySelector(`.page-input-${sid}-${i}`);
                    
                    if (levelInput && values[`c${i+1}`]) {
                        levelInput.value = values[`c${i+1}`];
                    }
                    if (pageSelect && values[`p${i+1}`]) {
                        pageSelect.value = values[`p${i+1}`];
                    }
                }
            });
            
            showToast('üìÇ Draft loaded');
        }
    }

    // Swipe navigation
    function setupSwipeNavigation() {
        let touchstartX = 0;
        let touchendX = 0;
        
        document.addEventListener('touchstart', e => {
            touchstartX = e.changedTouches[0].screenX;
        }, { passive: true });
        
        document.addEventListener('touchend', e => {
            touchendX = e.changedTouches[0].screenX;
            handleSwipe();
        }, { passive: true });
        
        function handleSwipe() {
            const cards = document.querySelectorAll('.student-card');
            if (cards.length === 0) return;
            
            // Find current visible card
            let currentIndex = 0;
            cards.forEach((card, idx) => {
                if (card.style.display !== 'none') {
                    currentIndex = idx;
                }
            });
            
            // Hide all
            cards.forEach(card => card.style.display = 'none');
            
            if (touchendX < touchstartX - 50) {
                // Swipe left - next
                currentIndex = (currentIndex + 1) % cards.length;
            } else if (touchendX > touchstartX + 50) {
                // Swipe right - previous
                currentIndex = (currentIndex - 1 + cards.length) % cards.length;
            } else {
                // No swipe, show current
                cards[currentIndex].style.display = 'block';
                updateCounter(currentIndex, cards.length);
                return;
            }
            
            // Show new card
            cards[currentIndex].style.display = 'block';
            updateCounter(currentIndex, cards.length);
        }
    }

    function updateCounter(current, total) {
        const counter = document.getElementById('studentCounter');
        if (counter) {
            counter.innerHTML = `Student ${current + 1} of ${total} üëà Swipe to navigate üëâ`;
        }
    }

    // Show toast notification
    function showToast(message) {
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 2000);
    }

    // Save all records (works for both views)
    window.saveAllBatch = async () => {
        let rows, logDate;
        
        if (viewMode === 'mobile') {
            rows = document.querySelectorAll('.student-card');
            logDate = document.getElementById('mobileBatchDate')?.value;
        } else {
            rows = document.querySelectorAll('#batchTableBody tr');
            logDate = document.getElementById('batchDate').value;
        }
        
        if (!logDate) { 
            showToast("‚ö†Ô∏è Please select a date");
            return; 
        }
        
        if (rows.length === 0) return;
        
        // Validate inputs
        let hasError = false;
        if (viewMode === 'mobile') {
            document.querySelectorAll('input[type="number"]').forEach(input => {
                if (parseInt(input.value) < 0) {
                    input.classList.add('error');
                    hasError = true;
                }
            });
        }
        
        if (hasError) {
            showToast("‚ö†Ô∏è Please fix negative values");
            return;
        }
        
        const confirmSave = confirm(`Submit records for ${rows.length} students?`);
        if (!confirmSave) return;

        const btn = viewMode === 'mobile' ? document.getElementById('mobileSaveBtn') : document.getElementById('saveAllBtn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span> Saving...';

        try {
            const labels = divisionLabels[teacherData.division] || ["S1", "S2", "S3"];
            let successCount = 0;
            
            for (let row of rows) {
                let sid, attn, perf, lv = {c1:0, c2:0, c3:0};
                let pages = {p1:'-', p2:'-', p3:'-'};
                
                if (viewMode === 'mobile') {
                    sid = row.dataset.sid;
                    attn = document.querySelector(`.attn-${sid}`)?.value || 'P';
                    perf = document.querySelector(`.perf-${sid}`)?.value || 'Good';
                    
                    for(let i=0; i<3; i++) {
                        const levelInput = document.querySelector(`.level-input-${sid}-${i}`);
                        const pageSelect = document.querySelector(`.page-input-${sid}-${i}`);
                        
                        if (levelInput) lv[`c${i+1}`] = parseInt(levelInput.value) || 0;
                        if (pageSelect) pages[`p${i+1}`] = pageSelect.value;
                    }
                } else {
                    sid = row.dataset.sid;
                    attn = row.querySelector('.attn')?.value || 'P';
                    perf = row.querySelector('.perf')?.value || 'Good';
                    
                    lv = {
                        c1: parseInt(row.querySelector('.l1')?.value) || 0,
                        c2: parseInt(row.querySelector('.l2')?.value) || 0,
                        c3: parseInt(row.querySelector('.l3')?.value) || 0
                    };
                    
                    pages = {
                        p1: row.querySelector('.p1')?.value || '-',
                        p2: row.querySelector('.p2')?.value || '-',
                        p3: row.querySelector('.p3')?.value || '-'
                    };
                }
                
                // Create log text (same format for compatibility)
                const logText = `[Attn: ${attn}] [${perf}] ${labels[0]}: Lvl ${lv.c1} Pg ${pages.p1} | ${labels[1]}: Lvl ${lv.c2} Pg ${pages.p2} | ${labels[2]}: Lvl ${lv.c3} Pg ${pages.p3}`;
                
                // Update Firebase
                const sRef = doc(db, "students", sid);
                const sSnap = await getDoc(sRef);
                const currentLogs = sSnap.data().logs || [];
                
                await updateDoc(sRef, {
                    levels: lv,
                    logs: [{ date: logDate, text: logText, timestamp: new Date() }, ...currentLogs].slice(0, 100)
                });
                
                successCount++;
            }
            
            // Clear draft after successful save
            localStorage.removeItem('teacherDraft');
            
            showToast(`‚úÖ Success! ${successCount} records saved.`);
            window.switchTab('dashboard');
            
        } catch (e) { 
            showToast("‚ùå Error: " + e.message); 
        } finally {
            btn.disabled = false;
            btn.innerHTML = "‚úÖ Submit All Records";
        }
    };

    // History functions (unchanged)
    async function populateHistoryDropdown() {
        const sel = document.getElementById('historyStudentSelect');
        const q = query(collection(db, "students"), where("division", "==", teacherData.division));
        const snap = await getDocs(q);
        sel.innerHTML = '<option value="">-- Choose Student --</option>' + 
            snap.docs.map(d => `<option value="${d.id}">${d.data().name}</option>`).join('');
        sel.onchange = loadStudentHistory;
        document.getElementById('historyMonthFilter').onchange = loadStudentHistory;
    }

    async function loadStudentHistory() {
        const sid = document.getElementById('historyStudentSelect').value;
        const monthFilter = document.getElementById('historyMonthFilter').value;
        const res = document.getElementById('historyResult');
        
        if(!sid) {
            res.innerHTML = '<p style="color:#666; text-align:center; padding:20px;">Select a student to view the academic table.</p>';
            return;
        }

        const sDoc = await getDoc(doc(db, "students", sid));
        let logs = sDoc.data().logs || [];
        const labels = divisionLabels[teacherData.division] || ["S1", "S2", "S3"];

        if (monthFilter !== 'all') {
            logs = logs.filter(log => log.date && log.date.split('-')[1] === monthFilter);
        }

        if (!logs.length) {
            res.innerHTML = "<p style='text-align:center; padding:20px;'>No records found for the selected criteria.</p>";
            return;
        }

        let tableHtml = `
            <table class="hist-table" style="min-width:900px;">
                <thead>
                    <tr>
                        <th rowspan="2" style="width:120px;">Date</th>
                        <th rowspan="2" style="width:60px;">Attn</th>
                        <th colspan="2">${labels[0]}</th>
                        <th colspan="2">${labels[1]}</th>
                        <th colspan="2">${labels[2]}</th>
                        <th rowspan="2" style="width:120px;">Perf.</th>
                    </tr>
                    <tr>
                        <th>Lvl</th><th>Pg</th>
                        <th>Lvl</th><th>Pg</th>
                        <th>Lvl</th><th>Pg</th>
                    </tr>
                </thead>
                <tbody>`;

        logs.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(log => {
            const attnMatch = log.text.match(/\[Attn: (.*?)\]/);
            const perfMatch = log.text.match(/\] \[(.*?)\]/);
            const attn = attnMatch ? attnMatch[1] : "-";
            const perf = perfMatch ? perfMatch[1] : "-";
            const progressParts = log.text.split('|');
            
            const extractData = (part) => {
                if(!part) return { lvl: "-", pg: "-" };
                const lMatch = part.match(/Lvl (.*?) /);
                const pMatch = part.match(/Pg (.*?)$/);
                return { lvl: lMatch ? lMatch[1] : "-", pg: pMatch ? pMatch[1] : "-" };
            };

            const s1 = extractData(progressParts[0]);
            const s2 = extractData(progressParts[1]);
            const s3 = extractData(progressParts[2]);

            tableHtml += `
                <tr>
                    <td style="font-weight:bold;">${log.date}</td>
                    <td><span class="attn-badge attn-${attn}">${attn}</span></td>
                    <td>${s1.lvl}</td><td style="font-weight:bold; color:var(--primary);">${s1.pg}</td>
                    <td>${s2.lvl}</td><td style="font-weight:bold; color:var(--primary);">${s2.pg}</td>
                    <td>${s3.lvl}</td><td style="font-weight:bold; color:var(--primary);">${s3.pg}</td>
                    <td><span class="attn-badge" style="background:#e3f2fd;">${perf}</span></td>
                </tr>`;
        });

        tableHtml += `</tbody></table>`;
        res.innerHTML = tableHtml;
    }

    async function loadNotice() {
        const q = query(collection(db, "notices"), orderBy("timestamp", "desc"), limit(1));
        const snap = await getDocs(q);
        if (!snap.empty) {
            document.getElementById('noticeBar').style.display = 'block';
            document.getElementById('noticeText').innerText = snap.docs[0].data().message;
        }
    }

    window.logout = () => { 
        localStorage.clear(); 
        window.location.href = 'index.html'; 
    };

    // Start the app
    init();
</script>
</body>
</html>
